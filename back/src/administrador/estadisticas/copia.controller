import { Controller, Get, Res, SetMetadata, UseGuards } from '@nestjs/common';
import { EstadisticasService } from './estadisticas.service';
import { RolesGuard } from 'src/roles/roles.guard';
import * as XLSX from 'xlsx';

@Controller('estadisticas')
export class EstadisticasController {
  constructor(public estadostica: EstadisticasService) {}

  @Get()
  @UseGuards(RolesGuard)
  @SetMetadata('roles', ['ADMINISTRADOR'])
  async registro_iniciado(@Res() res) {
    const data = await this.estadostica.historial_iniciados();

    // Crear el libro de Excel y la hoja de trabajo
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Sesiones');

    // Generar el archivo Excel
    const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'buffer' });

    // Descargar el archivo Excel
    res.set('Content-Disposition', 'attachment; filename="sesiones.xlsx"');
    res.type('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.send(excelBuffer);
  }
}